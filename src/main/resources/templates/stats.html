<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head th:replace="~{fragments/common :: common_head}">
    <title>学習統計 - VocabSpring</title>
</head>

<body
    class="bg-background-light dark:bg-background-dark font-display text-slate-900 dark:text-slate-100 min-h-screen flex flex-col">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Header Fragment -->
    <header th:replace="~{fragments/common :: header}"></header>

    <main class="flex-1 px-6 pb-32 space-y-12 overflow-y-auto max-w-pc w-full">

        <div class="pt-2 text-center md:text-left">
            <h2 class="text-3xl font-black tracking-tight">学習統計</h2>
            <p class="text-sm text-slate-500 font-medium mt-1">日々の努力を数値とグラフで振り返りましょう。</p>
        </div>

        <!-- Data Available Section -->
        <div th:if="${totalStats.totalAnswered > 0}" class="space-y-16">

            <!-- Total Summary Grid -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div
                    class="neu-raised rounded-3xl p-6 text-center space-y-2 bg-white/40 group hover:bg-white transition-all">
                    <div
                        class="w-12 h-12 rounded-2xl neu-pressed mx-auto flex items-center justify-center text-primary/60 bg-slate-50 mb-2">
                        <span class="material-symbols-outlined">quiz</span>
                    </div>
                    <p class="text-3xl font-black text-slate-800" th:text="${totalStats.totalAnswered}">0</p>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">総解答数</p>
                </div>
                <div
                    class="neu-raised rounded-3xl p-6 text-center space-y-2 bg-white/40 group hover:bg-white transition-all">
                    <div
                        class="w-12 h-12 rounded-2xl neu-pressed mx-auto flex items-center justify-center text-green-500/60 bg-slate-50 mb-2">
                        <span class="material-symbols-outlined">done_all</span>
                    </div>
                    <p class="text-3xl font-black text-slate-800"
                        th:text="${#numbers.formatDecimal(totalStats.correctRate, 1, 1)} + '%'">0%</p>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">総合正答率</p>
                </div>
                <div
                    class="neu-raised rounded-3xl p-6 text-center space-y-2 bg-white/40 group hover:bg-white transition-all">
                    <div
                        class="w-12 h-12 rounded-2xl neu-pressed mx-auto flex items-center justify-center text-primary/60 bg-slate-50 mb-2">
                        <span class="material-symbols-outlined">library_books</span>
                    </div>
                    <p class="text-3xl font-black text-slate-800" th:text="${totalStats.totalWords}">0</p>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">現在の単語数</p>
                </div>
                <div
                    class="neu-raised rounded-3xl p-6 text-center space-y-2 bg-white/40 group hover:bg-white transition-all">
                    <div
                        class="w-12 h-12 rounded-2xl neu-pressed mx-auto flex items-center justify-center text-orange-500/60 bg-slate-50 mb-2">
                        <span class="material-symbols-outlined">fitness_center</span>
                    </div>
                    <p class="text-3xl font-black text-slate-800" th:text="${totalStats.weakWordCount}">0</p>
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">克服すべき単語</p>
                </div>
            </div>

            <!-- Category Specific Sections -->
            <section th:each="cat, iterStat : ${categoryDetailStats}"
                class="space-y-8 pt-10 border-t border-slate-200/50">
                <div class="flex items-center gap-4">
                    <div
                        class="w-10 h-10 rounded-xl neu-raised flex items-center justify-center text-primary shadow-sm bg-white/80">
                        <span class="material-symbols-outlined !text-xl">label</span>
                    </div>
                    <h3 class="text-xl font-black text-slate-700 tracking-tight" th:text="${cat.categoryName}">カテゴリ名
                    </h3>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-stretch">
                    <!-- Category Stats Cards -->
                    <div class="flex flex-col gap-4">
                        <div class="neu-raised rounded-2xl p-6 flex flex-col justify-center bg-white/50 h-full">
                            <div class="flex justify-between items-end mb-4">
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">正答率</span>
                                <span class="text-3xl font-black"
                                    th:classappend="${cat.correctRate >= 80} ? 'text-green-500' : (${cat.correctRate >= 50} ? 'text-orange-500' : 'text-red-500')"
                                    th:text="${#numbers.formatDecimal(cat.correctRate, 1, 1)} + '%'">0%</span>
                            </div>
                            <div class="w-full h-3 bg-slate-100 rounded-full overflow-hidden neu-pressed p-0.5">
                                <div class="h-full rounded-full transition-all duration-1000 shadow-sm"
                                    th:style="'width:' + ${cat.correctRate} + '%; background-color:' + (${cat.correctRate >= 80} ? '#22c55e' : (${cat.correctRate >= 50} ? '#f59e0b' : '#ef4444'))">
                                </div>
                            </div>
                        </div>
                        <div class="neu-raised rounded-2xl p-6 bg-white/50 flex items-center justify-between">
                            <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">総解答数</span>
                            <span class="text-2xl font-black text-slate-700" th:text="${cat.totalAnswered}">0</span>
                        </div>
                    </div>

                    <!-- Chart Area -->
                    <div class="lg:col-span-2 neu-pressed rounded-3xl p-8 bg-white/20 relative overflow-hidden h-full">
                        <div class="absolute -bottom-12 -right-12 w-48 h-48 bg-primary/5 rounded-full blur-3xl"></div>
                        <h4
                            class="text-[10px] font-black text-primary uppercase tracking-[0.2em] mb-6 flex items-center gap-2">
                            <span class="material-symbols-outlined text-sm">show_chart</span>
                            直近14日間の習得推移
                        </h4>
                        <div class="h-[220px] w-full relative z-10">
                            <canvas th:id="'chart-' + ${iterStat.index}"></canvas>
                        </div>
                    </div>
                </div>
            </section>

        </div>

        <!-- Empty State Section -->
        <div th:if="${totalStats.totalAnswered == 0}"
            class="flex flex-col items-center justify-center py-24 text-center space-y-8 max-w-sm mx-auto">
            <div class="w-24 h-24 rounded-full neu-pressed flex items-center justify-center text-slate-200">
                <span class="material-symbols-outlined !text-5xl">bar_chart_4_bars</span>
            </div>
            <div class="space-y-2">
                <h3 class="text-xl font-black text-slate-800">統計データがありません</h3>
                <p class="text-sm text-slate-400 font-medium">まずはクイズに挑戦して、現在のレベルを確認してみましょう。</p>
            </div>
            <a th:href="@{/quiz/settings}">
                <button
                    class="neu-button-primary px-10 py-5 rounded-2xl font-black uppercase tracking-widest text-sm text-white shadow-xl">
                    学習を始める
                </button>
            </a>
        </div>

    </main>

    <!-- Bottom Navigation Fragment -->
    <nav th:replace="~{fragments/common :: bottom_nav('stats')}"></nav>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const categoryDetailStats = /*[[${categoryDetailStats}]]*/[];

        categoryDetailStats.forEach((cat, i) => {
            const dailyData = cat.dailyStats;
            if (!dailyData || dailyData.length === 0) return;

            const canvasId = 'chart-' + i;
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            const gradient1 = ctx.createLinearGradient(0, 0, 0, 200);
            gradient1.addColorStop(0, 'rgba(164, 146, 121, 0.2)');
            gradient1.addColorStop(1, 'rgba(164, 146, 121, 0)');

            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: dailyData.map(d => d.date.split('-').slice(1).join('/')),
                    datasets: [
                        {
                            label: '正解',
                            data: dailyData.map(d => d.correctCount),
                            borderColor: '#a49279',
                            backgroundColor: gradient1,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#a49279',
                            pointBorderWidth: 2,
                            borderWidth: 4
                        },
                        {
                            label: '不正解',
                            data: dailyData.map(d => d.incorrectCount),
                            borderColor: '#e2e8f0',
                            backgroundColor: 'transparent',
                            fill: false,
                            tension: 0.4,
                            pointRadius: 0,
                            borderWidth: 2,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.03)' },
                            ticks: { font: { size: 10, weight: 'bold' }, color: '#94a3b8' }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: { size: 10, weight: 'bold' }, color: '#94a3b8' }
                        }
                    }
                }
            });
        });
        /*]]>*/
    </script>
</body>

</html>